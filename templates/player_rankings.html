{% extends 'base.html' %}

{% block content %}
    <div class="container mt-4">
        <h1 class="mb-4">Fantasy Player Rankings (VORP & VOAS)</h1>

        <form id="rankings-form" onsubmit="event.preventDefault(); fetchRankings();">
            {% csrf_token %}
            <div class="mb-3">
                <label for="num_teams" class="form-label">Number of Teams</label>
                <select id="num_teams" class="form-select">
                    <option value="8">8</option>
                    <option value="10">10</option>
                    <option value="12" selected>12</option>
                    <option value="16">16</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="ppr_type" class="form-label">Scoring Type</label>
                <select id="ppr_type" class="form-select">
                    <option value="std">Standard</option>
                    <option value="half">Half PPR</option>
                    <option value="full" selected>Full PPR</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Get Rankings</button>
        </form>

        <hr>

        <div id="results" class="mt-4">
            <!-- Rankings will be inserted here -->
        </div>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function fetchRankings() {
            const numTeams = document.getElementById("num_teams").value;
            const pprType = document.getElementById("ppr_type").value;
            const csrftoken = getCookie('csrftoken');

            fetch("/api/player_rankings/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({
                    num_teams: parseInt(numTeams),
                    ppr_type: pprType
                }),
            })
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById("results");
                    let html = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Position</th>
                            <th>Team</th>
                            <th>Avg Proj</th>
                            <th>VORP</th>
                            <th>VOAS</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

                    data.forEach((player, index) => {
                        html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${player.name}</td>
                        <td>${player.position}</td>
                        <td>${player.team}</td>
                        <td>${player.avg_proj}</td>
                        <td>${player.vorp}</td>
                        <td>${player.voas}</td>
                    </tr>
                `;
                    });

                    html += "</tbody></table>";
                    container.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById("results").innerHTML = `<div class="alert alert-danger">Error fetching rankings.</div>`;
                    console.error("Error:", error);
                });
        }
    </script>
{% endblock %}
