{% extends 'base.html' %}

{% block content %}
    <div class="container mt-4">
        <h1 class="mb-4">Fantasy Player Rankings (VORP & VOAS)</h1>

        <form id="rankings-form" onsubmit="event.preventDefault(); fetchRankings();">
            {% csrf_token %}
            <div class="mb-3">
                <label for="num_teams" class="form-label">Number of Teams</label>
                <select id="num_teams" class="form-select">
                    <option value="8">8</option>
                    <option value="10">10</option>
                    <option value="12" selected>12</option>
                    <option value="16">16</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="ppr_type" class="form-label">Scoring Type</label>
                <select id="ppr_type" class="form-select">
                    <option value="std">Standard</option>
                    <option value="full" selected>Full PPR</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="position_filter" class="form-label">Filter by Position</label>
                <select id="position_filter" class="form-select" onchange="fetchRankings()">
                    <option value="all" selected>All</option>
                    <option value="QB">QB</option>
                    <option value="RB">RB</option>
                    <option value="WR">WR</option>
                    <option value="TE">TE</option>
                    <option value="K">K</option>
                    <option value="DEF">DEF</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="sort_by" class="form-label">Sort By</label>
                <select id="sort_by" class="form-select" onchange="fetchRankings()">
                    <option value="vorp" selected>VORP</option>
                    <option value="voas">VOAS</option>
                    <option value="avg_proj">Avg Projected</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Get Rankings</button>
        </form>

        <hr>

        <div id="results" class="mt-4">
            <!-- Rankings will be inserted here -->
        </div>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function fetchRankings() {
            const numTeams = document.getElementById("num_teams").value;
            const pprType = document.getElementById("ppr_type").value;
            const position = document.getElementById("position_filter").value;
            const sortBy = document.getElementById("sort_by").value;
            const csrftoken = getCookie('csrftoken');

            fetch("/api/player_rankings/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({
                    num_teams: parseInt(numTeams),
                    ppr_type: pprType,
                    position: position,
                    sort_by: sortBy
                }),
            })
                .then(response => response.json())
                .then(data => {
                    renderTable(data);
                })
                .catch(error => {
                    document.getElementById("results").innerHTML =
                        `<div class="alert alert-danger">Error fetching rankings.</div>`;
                    console.error("Error:", error);
                });
        }

        function renderTable(players) {
            const container = document.getElementById("results");
            let html = `
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Position</th>
                        <th>Team</th>
                        <th>Avg Proj</th>
                        <th>VORP</th>
                        <th>VOAS</th>
                    </tr>
                </thead>
                <tbody>
        `;

            players.forEach(player => {
                html += `
                <tr>
                    <td>${player.name}</td>
                    <td>${player.position}</td>
                    <td>${player.team}</td>
                    <td>${Number(player.avg_proj).toFixed(2)}</td>
                    <td>${Number(player.vorp).toFixed(2)}</td>
                    <td>${Number(player.voas).toFixed(2)}</td>
                </tr>
            `;
            });

            html += "</tbody></table>";
            container.innerHTML = html;
        }
    </script>
{% endblock %}
